<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Crypto Portfolio</title>
<style>
body {
    margin:0;
    background:#0a0f1a;
    font-family: 'Roboto', Arial, sans-serif;
    color:#fff;
}

header {
    background:#0f1526;
    padding:20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 3px 10px rgba(0,0,0,0.5);
}

header h2 {
    margin:0;
    font-size:18px;
}

header .user-info {
    display:flex;
    flex-direction:column;
    align-items:flex-end;
}

header .logout {
    margin-top:5px;
    padding:6px 12px;
    background:#1f6bff;
    color:#fff;
    border:none;
    border-radius:5px;
    cursor:pointer;
    font-size:12px;
}

.container {
    padding:20px;
}

.card {
    background:#121833;
    padding:20px;
    border-radius:10px;
    margin-bottom:20px;
    box-shadow:0 4px 15px rgba(0,0,0,0.3);
}

.card h3 {
    margin-top:0;
    margin-bottom:15px;
    font-size:18px;
    letter-spacing:1px;
    color:#3ddc97;
}

.table-container {
    max-height:450px;
    overflow-y:auto;
    border-radius:10px;
}

table {
    width:100%;
    border-collapse:collapse;
}

th, td {
    padding:12px 10px;
    text-align:left;
}

th {
    background:#1a1f33;
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:1px;
}

tr:nth-child(even) { background:#0f1320; }
tr:hover { background:#1f2033; }

.symbol { font-weight:600; }
.price { text-align:right; transition:all 0.5s ease; }
.change { text-align:right; }
.rank { text-align:center; width:40px; }
.green { color:#3ddc97; transition:color 0.3s; }
.red { color:#ff6b6b; transition:color 0.3s; }

.pagination {
    margin-top:10px;
    display:flex;
    justify-content:center;
    gap:10px;
}

.page-btn {
    padding:6px 12px;
    background:#1f6bff;
    color:#fff;
    border:none;
    border-radius:4px;
    cursor:pointer;
    font-size:12px;
    transition:all 0.3s;
}

.page-btn:hover {
    background:#3ddc97;
}

</style>
</head>
<body>

<header>
    <h2>Crypto Portfolio</h2>
    <div class="user-info">
        <div>Username: <span id="username"></span></div>
        <div>Email: <span id="email"></span></div>
        <button class="logout" onclick="logout()">Logout</button>
    </div>
</header>

<div class="container">
    <div class="card">
        <h3>Account Overview</h3>
        <p>Balance: <strong id="balance">$0</strong></p>
        <p>Equity: <strong id="equity">$0</strong></p>
    </div>

    <div class="card">
        <h3>Top Cryptocurrencies</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="rank">#</th>
                        <th>Symbol</th>
                        <th class="price">Price (USD)</th>
                        <th class="change">24h %</th>
                    </tr>
                </thead>
                <tbody id="market-table"></tbody>
            </table>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<script src="user-data.js"></script>
<script>
let coinList = []; // 存储前100币种
const priceMap = {}; // 用于检测价格跳动
const itemsPerPage = 10;
let currentPage = 1;

// 页面初始化
window.onload = async function() {
    const currentUser = localStorage.getItem("currentUser");
    if (!currentUser) {
        alert("No user logged in");
        window.location.href = "index.html";
        return;
    }

    document.getElementById("username").innerText = currentUser;
    // 你可以在 user-data.js 里增加 email 字段
    const data = getUserData(currentUser);
    document.getElementById("email").innerText = data.email || "user@example.com";
    document.getElementById("balance").innerText = "$" + data.balance.toLocaleString();
    document.getElementById("equity").innerText = "$" + data.equity.toLocaleString();

    await fetchTop100();
    setInterval(fetchTop100, 10000); // 每10秒刷新
}

// 注销
function logout() {
    localStorage.removeItem("currentUser");
    window.location.href = "index.html";
}

// 获取Top100加密货币
async function fetchTop100() {
    const url = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&price_change_percentage=24h";
    try {
        const res = await fetch(url);
        coinList = await res.json();
        displayPage(currentPage);
        setupPagination();
    } catch (err) {
        console.error("Fetch error:", err);
    }
}

// 分页显示
function displayPage(page) {
    currentPage = page;
    const tbody = document.getElementById("market-table");
    tbody.innerHTML = "";

    const start = (page -1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageCoins = coinList.slice(start, end);

    pageCoins.forEach((coin, idx) => {
        const change = (coin.price_change_percentage_24h ?? 0).toFixed(2);
        const changeClass = change >=0 ? "green" : "red";

        // 动态价格跳动效果
        let prevPrice = priceMap[coin.id] ?? coin.current_price;
        let priceClass = "";
        if (coin.current_price > prevPrice) priceClass = "green";
        else if (coin.current_price < prevPrice) priceClass = "red";
        priceMap[coin.id] = coin.current_price;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="rank">${start + idx + 1}</td>
            <td class="symbol">${coin.symbol.toUpperCase()}</td>
            <td class="price ${priceClass}">$${Number(coin.current_price).toLocaleString()}</td>
            <td class="change ${changeClass}">${change}%</td>
        `;
        tbody.appendChild(tr);
    });
}

// 分页按钮
function setupPagination() {
    const totalPages = Math.ceil(coinList.length / itemsPerPage);
    const container = document.getElementById("pagination");
    container.innerHTML = "";
    for(let i=1; i<=totalPages; i++) {
        const btn = document.createElement("button");
        btn.className = "page-btn";
        btn.innerText = i;
        if(i === currentPage) btn.style.background="#3ddc97";
        btn.onclick = ()=> displayPage(i);
        container.appendChild(btn);
    }
}

</script>
</body>
</html>
